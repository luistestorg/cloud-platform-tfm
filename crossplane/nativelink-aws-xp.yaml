apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: nativelinks.tracemachina.com
spec:
  group: tracemachina.com
  names:
    kind: NativeLink
    plural: nativelinks
  versions:
    - name: v1alpha1
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                eks:
                  type: object
                  properties:
                    awsAccountID:
                      type: string
                    region:
                      type: string
                    domain:
                      type: string
                    eksOIDC:
                      type: string
                    clusterIssuer:
                      type: string
                    sharedS3Bucket:
                      type: string
                    sharedS3BucketArn:
                      type: string
                    logS3Bucket:
                      type: string
                  required:
                    - awsAccountID
                    - eksOIDC
                    - region
                    - domain
                gke:
                  type: object
                  properties:
                    region:
                      type: string
                    domain:
                      type: string
                    clusterIssuer:
                      type: string
                  required:
                    - region
                    - domain
                namespace:
                  type: object
                  properties:
                    subdomain:
                      type: string
                    contactName:
                      type: string
                    contactEmail:
                      type: string
                    accountId:
                      type: string
                    deployState:
                      type: string
                      description: "Indicates the current state of a claim, such as dormant or deactivated due to inactivity and age."
                    nativeLinkImage:
                      type: string
                    whitelistSourceRange:
                      type: string
                    rpsRateLimit:
                      type: string
                    perIpConnectionLimit:
                      type: string
                    deployType:
                      type: string
                    ingressTLSSecret:
                      type: string
                    ingressAuthTLSSecret:
                      type: string
                    alias:
                      type: string
                    numShards:
                      type: integer
                      default: 100
                    ingressTLSHosts:
                      type: array
                      items:
                        type: string
                    scheduler:
                      type: object
                      properties:
                        replicas:
                          type: integer
                          default: 0
                        rustLog:
                          type: string
                          default: "info"
                        configMapName:
                          type: string
                          default: "scheduler-config"
                        cpuArch:
                          type: string
                          default: "amd64"
                        workersIngress:
                          type: boolean
                          default: false
                          description: 'Expose endpoint to allow external workers to register through the ingress'
                        workerInitImageTag:
                          type: string
                          description: 'Default tag for worker init image'
                        env:
                          type: array
                          items:
                            type: object
                            properties:
                              name:
                                description: 'Environment variable name'
                                type: string
                              value:
                                description: 'Environment variable value'
                                type: string
                    bep:
                      type: object
                      properties:
                        enabled:
                          description: 'Defaults to true, set to false to disable BEP support for this claim'
                          type: boolean
                          default: true
                        collection:
                          type: string
                          description: 'Collection where to index BEP events, defaults to the subdomain'
                        imageTag:
                          type: string
                          description: 'Image tag for the bep-etl deployment in the claim'
                          default: "latest"
                        channel:
                          type: string
                          description: 'pub/sub channel for BEP events'
                          default: "BEP"
                        keyPrefix:
                          type: string
                          description: 'key prefix'
                        keyspace:
                          type: string
                          description: "Redis keyspace for BEP entries, more informational as its set on URL"
                        redisUrl:
                          type: string
                          description: 'Redis URL for BEP events'
                    redis:
                      type: object
                      properties:
                        disabled:
                          description: 'Defaults to enabled, set to true to disable Redis'
                          type: boolean
                        maxMemory:
                          type: string
                          description: 'Max memory passed as arg to the Redis process'
                        volumeName:
                          type: string
                          description: "Create a PVC for an existing volume"
                        diskSize:
                          type: string
                          description: "Size of the PVC"
                          default: "12Gi"
                        replicas:
                          type: integer
                          description: "Number of sentinel replicas to run in namespace"
                          default: 3
                        resources:
                          type: object
                          description: 'Compute Resources required by this container'
                          properties:
                            limits:
                              additionalProperties:
                                anyOf:
                                  - type: integer
                                  - type: string
                                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                x-kubernetes-int-or-string: true
                              description: 'Limits describes the maximum amount of compute resources allowed'
                              type: object
                            requests:
                              additionalProperties:
                                anyOf:
                                  - type: integer
                                  - type: string
                                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                x-kubernetes-int-or-string: true
                              description: 'Requests describes the minimum amount of compute resources required. If Requests is omitted for a container, it defaults to Limits if that is explicitly specified, otherwise to an implementation-defined value. Requests cannot exceed Limits.'
                              type: object
                    cas:
                      type: object
                      properties:
                        disabled:
                          description: 'Defaults to enabled, set to true to disable CAS'
                          type: boolean
                        toleratesSpot:
                          type: boolean
                          description: 'Set to true if this CAS supports scheduling on SPOT instances, defaults to false'
                        browserEnabled:
                          type: boolean
                          description: 'Set to true to enable BB-Browser, defaults to false'
                          default: false
                        zone:
                          type: string
                        rustLog:
                          type: string
                          default: "warn"
                        configMapName:
                          type: string
                        redisMode:
                          type: string
                          default: "standard"
                        casRedisUrl:
                          type: string
                          description: "Redis URL for CAS entries"
                        acKeyPrefix:
                          type: string
                          description: "Prefix for all keys for action cache entries from this claim; useful when using the multi-tenant Redis"
                        acRedisUrl:
                          type: string
                          description: "Redis URL for ActionCache entries"
                        acKeyspace:
                          type: string
                          description: "Redis keyspace for ActionCache entries, more informational as its set on URL"
                        casKeyPrefix:
                          type: string
                          description: "Prefix for all keys for cas cache entries from this claim; useful when using the multi-tenant Redis"
                        cpuArch:
                          type: string
                          description: "CPU Architecture of the node where to schedule CAS pod on, defaults to amd64"
                          default: "amd64"
                        fsMaxBytes:
                          type: string
                          description: "Gives the max filesystem size if not using S3 as the CAS upper store"
                          default: "30gb"
                        pvcStorageClass:
                          type: string
                          description: "Create a persistent volume claim with this storageClass for CAS FS store when S3 not available"
                        pvcSize:
                          type: string
                          description: "Size of the PV, defaults to 50Gi"
                          default: "50Gi"
                        env:
                          type: array
                          items:
                            type: object
                            properties:
                              name:
                                description: 'Environment variable name'
                                type: string
                              value:
                                description: 'Environment variable value'
                                type: string
                        resources:
                          type: object
                          description: 'Compute Resources required by this container'
                          properties:
                            limits:
                              additionalProperties:
                                anyOf:
                                  - type: integer
                                  - type: string
                                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                x-kubernetes-int-or-string: true
                              description: 'Limits describes the maximum amount of compute resources allowed'
                              type: object
                            requests:
                              additionalProperties:
                                anyOf:
                                  - type: integer
                                  - type: string
                                pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                                x-kubernetes-int-or-string: true
                              description: 'Requests describes the minimum amount of compute resources required. If Requests is omitted for a container, it defaults to Limits if that is explicitly specified, otherwise to an implementation-defined value. Requests cannot exceed Limits.'
                              type: object
                  required:
                    - subdomain
                    - contactName
                    - contactEmail
                    - accountId
                    - nativeLinkImage
                    - ingressTLSHosts
              required:
                - namespace
            status:
              description: NativeLinkStatus defines the observed state of NativeLink app
              properties:
                bucketArn:
                  type: string
                bucketName:
                  type: string
                irsaRoleName:
                  type: string
              type: object
      served: true
      referenceable: true
  claimNames:
    kind: NativeLinkClaim
    plural: nativelinkclaims
---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: nativelink-naas
spec:
  mode: Pipeline
  pipeline:
  - step: deploy-bucket-and-iam
    functionRef:
      name: crossplane-contrib-function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          {{ if .observed.composite.resource.spec.eks.awsAccountID }}
          ---
          {{ $iamRoleResourceName := "irsa-iam-role" }}
          apiVersion: iam.aws.crossplane.io/v1beta1
          kind: Role
          metadata:
            name: "nativelink-irsa-{{ .observed.composite.resource.spec.namespace.subdomain }}"
            annotations:
              {{ setResourceNameAnnotation $iamRoleResourceName }}
          spec:
            deletionPolicy: Delete
            forProvider:
              assumeRolePolicyDocument: |
                {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Principal": {
                        "Federated": "arn:aws:iam::{{ .observed.composite.resource.spec.eks.awsAccountID }}:oidc-provider/{{ .observed.composite.resource.spec.eks.eksOIDC }}"
                      },
                      "Action": "sts:AssumeRoleWithWebIdentity",
                      "Condition": {
                        "StringLike": {
                          "{{ .observed.composite.resource.spec.eks.eksOIDC }}:sub": "system:serviceaccount:nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}:nativelink"
                        }
                      }
                    }
                  ]
                }
            providerConfigRef:
              name: provider-config-aws
          ---
          {{ $iamRole := getComposedResource . $iamRoleResourceName }}
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: irsa
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ServiceAccount
                metadata:
                  name: "nativelink"
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  annotations:
                    eks.amazonaws.com/role-arn: {{ get $iamRole.status.atProvider "arn" }}
          {{ if eq .observed.composite.resource.spec.namespace.deployType "dedicated" }}
          ---
          apiVersion: s3.aws.crossplane.io/v1beta1
          kind: Bucket
          metadata:
            annotations:
              {{ setResourceNameAnnotation "s3-bucket" }}
            labels:
              nativelink: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
          spec:
            providerConfigRef:
              name: provider-config-aws
            deletionPolicy: Orphan # can't delete S3 buckets once they have data in them, so must delete manually
            forProvider:
              locationConstraint: {{ .observed.composite.resource.spec.eks.region }}
              objectOwnership: BucketOwnerEnforced
              paymentConfiguration:
                payer: BucketOwner
              versioningConfiguration:
                status: Suspended
          {{ end }}
          ---
          apiVersion: iam.aws.crossplane.io/v1beta1
          kind: Policy
          metadata:
            name: "nativelink-s3-policy-{{ .observed.composite.resource.spec.namespace.subdomain }}"
            annotations:
              {{ setResourceNameAnnotation "s3-access-iam-policy" }}
          spec:
            deletionPolicy: Delete
            forProvider:
              name: "nativelink-s3-policy-{{ .observed.composite.resource.spec.namespace.subdomain }}"
              document: |
                {
                  "Version": "2012-10-17",
                  "Statement": [
                    {{- if eq .observed.composite.resource.spec.namespace.deployType "dedicated" }}
                    {{ $s3Bucket := getComposedResource . "s3-bucket" }}
                    {
                      "Action": ["s3:*", "s3-object-lambda:*"],
                      "Effect": "Allow",
                      "Resource": ["{{ $s3Bucket.status.atProvider.arn }}", "{{ $s3Bucket.status.atProvider.arn }}/*"]
                    },
                    {{- end }}
                    {
                      "Action": ["s3:*", "s3-object-lambda:*"],
                      "Effect": "Allow",
                      "Resource": ["{{ .observed.composite.resource.spec.eks.sharedS3BucketArn }}", "{{ .observed.composite.resource.spec.eks.sharedS3BucketArn }}/*"]
                    },
                    {
                      "Effect": "Allow",
                      "Action": [
                        "kms:*"
                      ],
                      "Resource": "*"
                    }
                  ]
                }
            providerConfigRef:
              name: provider-config-aws
          ---
          {{ $s3BucketPolicy := getComposedResource . "s3-access-iam-policy" }}
          apiVersion: iam.aws.crossplane.io/v1beta1
          kind: RolePolicyAttachment
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: s3-policy-attachment
          spec:
            deletionPolicy: Delete
            forProvider:
              roleName: "nativelink-irsa-{{ .observed.composite.resource.spec.namespace.subdomain }}"
              policyArn: {{ get $s3BucketPolicy.status.atProvider "arn" }}
            providerConfigRef:
              name: provider-config-aws
          ---
          apiVersion: {{ .observed.composite.resource.apiVersion }}
          kind: {{ .observed.composite.resource.kind }}
          status:
            irsaRoleName: "nativelink-irsa-{{ .observed.composite.resource.spec.namespace.subdomain }}"
            {{- if eq .observed.composite.resource.spec.namespace.deployType "dedicated" }}
            {{ $s3Bucket := getComposedResource . "s3-bucket" }}
            {{- if $s3Bucket }}
            bucketArn: {{ get $s3Bucket.status.atProvider "arn" }}
            bucketName: {{ index $s3Bucket.metadata.annotations "crossplane.io/external-name" }}
            {{- end }}
            {{- end }}
          {{ else }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: service-account
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ServiceAccount
                metadata:
                  name: "nativelink"
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
          {{ end }}
  - step: render-cas-config-template
    functionRef:
      name: crossplane-contrib-function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: redis-env
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ConfigMap
                metadata:
                  name: redis-env
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                data:
                  REDIS_MODE: "{{ .observed.composite.resource.spec.namespace.cas.redisMode }}"
                  REDIS_AC_SLOW_STORE_URL: "{{ or .observed.composite.resource.spec.namespace.cas.acRedisUrl .observed.composite.resource.spec.namespace.cas.casRedisUrl }}"
                  REDIS_CAS_SLOW_STORE_URL: "{{ .observed.composite.resource.spec.namespace.cas.casRedisUrl }}"
                  REDIS_SCHEDULER_URL: "redis+sentinel://redis-headless.nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}.svc.cluster.local:26379/0?sentinelServiceName={{ .observed.composite.resource.spec.namespace.subdomain }}"
                  {{- if .observed.composite.resource.spec.namespace.bep.enabled }}
                  REDIS_BEP_STORE_URL: "{{ .observed.composite.resource.spec.namespace.bep.redisUrl }}"
                  REDIS_BEP_CHANNEL: "{{ .observed.composite.resource.spec.namespace.bep.channel }}"
                  {{- end }}
                  {{- if .observed.composite.resource.spec.eks.region }}
                  AWS_REGION: "{{ .observed.composite.resource.spec.eks.region }}"
                  {{- end }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: grafana-dashboard
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ConfigMap
                metadata:
                  name: "grafana-dashboard"
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  labels:
                    grafana_dashboard: "1"
                data:

          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: cas-config
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ConfigMap
                metadata:
                  name: cas-config
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                data:
                  cas.json: |-
                    {
                      "servers": [
                        {
                          "listener": {
                            "http": {
                              "advanced_http": {
                                "experimental_http2_keep_alive_timeout": 1200
                              },
                              "compression": {
                                "accepted_compression_algorithms": [
                                  "gzip"
                                ],
                                "send_compression_algorithm": "gzip"
                              },
                              "socket_address": "0.0.0.0:50051"
                            }
                          },
                          "services": {
                            "ac": {
                              "": {
                                "ac_store": "AC_STORE"
                              },
                              "main": {
                                "ac_store": "AC_STORE"
                              }
                            },
                            "bytestream": {
                              "cas_stores": {
                                "": "CAS_STORE",
                                "main": "CAS_STORE"
                              }
                            },
                            "capabilities": {},
                            "cas": {
                              "": {
                                "cas_store": "CAS_STORE"
                              },
                              "main": {
                                "cas_store": "CAS_STORE"
                              }
                            }
                          }
                        },
                        {
                          "listener": {
                            "http": {
                              "socket_address": "0.0.0.0:50061"
                            }
                          },
                          "services": {
                            "experimental_prometheus": {
                              "path": "/metrics"
                            },
                            "health": {}
                          }
                        {{- if .observed.composite.resource.spec.namespace.bep.enabled }}
                        },
                        {
                          "listener": {
                            "http": {
                              "advanced_http": {
                                "experimental_http2_keep_alive_timeout": 1200
                              },
                              "compression": {
                                "accepted_compression_algorithms": [
                                  "gzip"
                                ],
                                "send_compression_algorithm": "gzip"
                              },
                              "socket_address": "0.0.0.0:50081"
                            }
                          },
                          "services": {
                            "experimental_bep": {
                              "store": "BEP_STORE"
                            },
                            "health": {}
                          }
                        {{- end }}
                        }
                      ],
                      "stores": [
                        {
                          "fast_slow": {
                            "fast": {
                              "size_partitioning": {
                                "lower_store": {
                                  "memory": {
                                    "eviction_policy": {
                                      "max_bytes": 100000000,
                                      "max_count": 150000
                                    }
                                  }
                                },
                                "size": 1000,
                                "upper_store": {
                                  "noop": {}
                                }
                              }
                            },
                            "slow": {
                              "ref_store": {
                                "name": "AC_REDIS_STORE"
                              }
                            }
                          },
                          "name": "AC_FAST_SLOW_STORE"
                        },
                        {
                          "name": "AC_REDIS_STORE",
                          "redis_store": {
                            "addresses": [
                              "${REDIS_AC_SLOW_STORE_URL}"
                            ],
                            "mode": "{{ .observed.composite.resource.spec.namespace.cas.redisMode }}"{{- if .observed.composite.resource.spec.namespace.cas.acKeyPrefix }}, "key_prefix": "{{ .observed.composite.resource.spec.namespace.cas.acKeyPrefix }}"{{- end }}
                          }
                        },
                        {
                          "completeness_checking": {
                            "backend": {
                              "ref_store": {
                                "name": "AC_FAST_SLOW_STORE"
                              }
                            },
                            "cas_store": {
                              "ref_store": {
                                "name": "CAS_STORE"
                              }
                            }
                          },
                          "name": "AC_STORE"
                        },
                        {{- if .observed.composite.resource.spec.namespace.bep.enabled }}
                        {
                          "name": "BEP_STORE",
                          "redis_store": {
                            "addresses": [
                              "${REDIS_BEP_STORE_URL}"
                            ],
                            "experimental_pub_sub_channel": "{{ .observed.composite.resource.spec.namespace.bep.channel }}",
                            "mode": "{{ .observed.composite.resource.spec.namespace.cas.redisMode }}"{{- if .observed.composite.resource.spec.namespace.bep.keyPrefix }}, "key_prefix": "{{ .observed.composite.resource.spec.namespace.bep.keyPrefix }}"{{- end }}
                          }
                        },
                        {{- end }}
                        {
                          "name": "CAS_FAST_SLOW_STORE",
                          "verify": {
                            "backend": {
                              "fast_slow": {
                                "fast": {
                                  "size_partitioning": {
                                    "lower_store": {
                                      "memory": {
                                        "eviction_policy": {
                                          "max_bytes": 1000000000,
                                          "max_count": 100000
                                        }
                                      }
                                    },
                                    "size": 64000,
                                    "upper_store": {
                                      "noop": {}
                                    }
                                  }
                                },
                                "slow": {
                                  "size_partitioning": {
                                    "lower_store": {
                                      "ref_store": {
                                        "name": "CAS_REDIS_STORE"
                                      }
                                    },
                                    "size": 2000000,
                                    "upper_store": {
                                      {{- if .observed.composite.resource.spec.eks.sharedS3Bucket }}
                                      "ref_store": {
                                        "name": "SHARD_S3_STORE"
                                      }
                                      {{- else }}
                                      "filesystem": {
                                        "content_path": "/tmp/nativelink/data/uppper-content-cas",
                                        "eviction_policy": {
                                          "max_bytes": "{{ .observed.composite.resource.spec.namespace.cas.fsMaxBytes }}"
                                        },
                                        "temp_path": "/tmp/nativelink/data/tmp_upper-cas"
                                      }
                                      {{- end }}
                                    }
                                  }
                                }
                              }
                            },
                            "verify_hash": true,
                            "verify_size": true
                          }
                        },
                        {{- if .observed.composite.resource.spec.eks.sharedS3Bucket }}
                        {
                          "name": "SHARD_S3_STORE",
                          "shard": {
                            "stores": [
                              {{- range $i := until ( .observed.composite.resource.spec.namespace.numShards | int ) }}
                              {
                                "store": {
                                  "experimental_s3_store": {
                                    "bucket": "${SHARED_CAS_BUCKET:-not_set}",
                                    "key_prefix": "cas/{{ $i }}/",
                                    "region": "${NATIVE_LINK_AWS_REGION:-us-east-1}"
                                  }
                                }
                              },
                              {{- end }}
                            ]
                          }
                        },
                        {{- end }}
                        {
                          "name": "CAS_REDIS_STORE",
                          "redis_store": {
                            "addresses": [
                              "${REDIS_CAS_SLOW_STORE_URL}"
                            ],
                            "mode": "{{ .observed.composite.resource.spec.namespace.cas.redisMode }}"{{- if .observed.composite.resource.spec.namespace.cas.casKeyPrefix }}, "key_prefix": "{{ .observed.composite.resource.spec.namespace.cas.casKeyPrefix }}"{{- end }}
                          }
                        },
                        {
                          "existence_cache": {
                            "backend": {
                              "ref_store": {
                                "name": "CAS_FAST_SLOW_STORE"
                              }
                            },
                            "eviction_policy": {
                              "max_count": 10000000,
                              "max_seconds": 1800
                            }
                          },
                          "name": "CAS_STORE"
                        }
                      ]
                    }
          {{- if .observed.composite.resource.spec.namespace.cas.pvcStorageClass }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: cas-pvc
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: PersistentVolumeClaim
                metadata:
                  name: cas-pvc
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  accessModes:
                    - ReadWriteOnce
                  resources:
                    requests:
                      storage: {{ .observed.composite.resource.spec.namespace.cas.pvcSize | default "50Gi" }}
                  storageClassName: {{ .observed.composite.resource.spec.namespace.cas.pvcStorageClass }}
          {{- end }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: cas-deployment
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  name: cas
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  labels:
                    nativelink: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  {{- if eq .observed.composite.resource.spec.namespace.deployState "deactivated" }}
                  replicas: 0
                  {{- else }}
                  replicas: 1
                  {{- end }}
                  selector:
                    matchLabels:
                      app: cas
                  template:
                    metadata:
                      annotations:
                        {{- if not .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                        "karpenter.sh/do-not-disrupt": "true"
                        cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
                        {{- end }}
                        "kubectl.kubernetes.io/default-container": "cas"
                      labels:
                        nativelink: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                        app.kubernetes.io/name: cas
                        app: cas
                    spec:
                      {{- if not .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                      terminationGracePeriodSeconds: 1800
                      priorityClassName: "nativelink-high-priority"
                      {{- end }}
                      affinity:
                        {{- if not .observed.composite.resource.spec.namespace.redis.disabled }}
                        podAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - weight: 100
                              podAffinityTerm:
                                labelSelector:
                                  matchExpressions:
                                    - key: nativelink
                                      operator: In
                                      values:
                                        - "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                                topologyKey: topology.kubernetes.io/zone
                        {{- end }}
                        {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                        {{- if .observed.composite.resource.spec.eks.awsAccountID }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: eks.amazonaws.com/capacityType
                                    operator: In
                                    values:
                                      - SPOT
                              weight: 100
                        {{- end }}
                        {{- if .observed.composite.resource.spec.gke.domain }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: cloud.google.com/gke-spot
                                    operator: In
                                    values:
                                      - "true"
                              weight: 100
                        {{- end }}
                        {{- else }}
                        {{- if .observed.composite.resource.spec.eks.awsAccountID }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: eks.amazonaws.com/capacityType
                                    operator: In
                                    values:
                                      - ON_DEMAND
                              weight: 100
                        {{- end }}
                        {{- end }}
                      nodeSelector:
                        {{- if .observed.composite.resource.spec.eks.domain }}
                        {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                        node-role: "autoscaled-ondemand"
                        {{- else }}
                        node-role: "not-disruptable"
                        {{- end }}
                        {{- end }}
                        kubernetes.io/arch: {{ or .observed.composite.resource.spec.namespace.cas.cpuArch "amd64" }}
                        kubernetes.io/os: "linux"
                      serviceAccountName: "nativelink"
                      containers:
                        - image: {{ .observed.composite.resource.spec.namespace.nativeLinkImage }}
                          imagePullPolicy: {{ if contains "dkr.ecr" .observed.composite.resource.spec.namespace.nativeLinkImage }}Always{{ else }}IfNotPresent{{ end }}
                          name: cas
                          livenessProbe:
                            httpGet:
                              path: /status
                              port: 50061
                              scheme: HTTP
                            failureThreshold: 5
                            initialDelaySeconds: 5
                            periodSeconds: 10
                            successThreshold: 1
                            timeoutSeconds: 1
                          readinessProbe:
                            httpGet:
                              path: /status
                              port: 50061
                              scheme: HTTP
                            failureThreshold: 5
                            initialDelaySeconds: 5
                            periodSeconds: 10
                            successThreshold: 1
                            timeoutSeconds: 1
                          ports:
                            - containerPort: 50051 # no TLS, terminates at ingress for now
                            - containerPort: 50061
                            {{- if .observed.composite.resource.spec.namespace.bep.enabled }}
                            - containerPort: 50081
                            {{- end }}
                          args: ["/etc/config/cas.json"]
                          envFrom:
                          - configMapRef:
                              name: redis-env
                              optional: false
                          env:
                            {{- if .observed.composite.resource.spec.eks.region }}
                            - name: NATIVE_LINK_AWS_REGION
                              value: "{{ .observed.composite.resource.spec.eks.region }}"
                            {{- end }}
                            {{- if eq .observed.composite.resource.spec.namespace.deployType "shared" }}
                            - name: SHARED_CAS_BUCKET
                              value: "{{ .observed.composite.resource.spec.eks.sharedS3Bucket }}"
                            {{- else }}
                            - name: SHARED_CAS_BUCKET
                              value: "{{ .observed.composite.resource.status.bucketName }}"
                            - name: NATIVE_LINK_AWS_S3_CAS_BUCKET
                              value: "{{ .observed.composite.resource.status.bucketName }}"
                            {{- end }}
                            - name: RUST_LOG
                              value: {{ or .observed.composite.resource.spec.namespace.cas.rustLog "warn" }}
                            - name: NL_LOG
                              value: json
                            {{- range .observed.composite.resource.spec.namespace.cas.env }}
                            - name: {{ .name }}
                              value: {{ .value }}
                            {{- end }}
                          volumeMounts:
                            - name: config-json
                              mountPath: /etc/config
                            - name: local-data
                              mountPath: /tmp/nativelink/data
                            - name: ca-certs
                              mountPath: /etc/ssl/certs
                          {{- if .observed.composite.resource.spec.namespace.cas.resources }}
                          resources:
                            {{- if .observed.composite.resource.spec.namespace.cas.resources.limits }}
                            limits:
                              {{- if .observed.composite.resource.spec.namespace.cas.resources.limits.memory }}
                              memory: {{ .observed.composite.resource.spec.namespace.cas.resources.limits.memory }}
                              {{- end }}
                            {{- end }}
                            {{- if .observed.composite.resource.spec.namespace.cas.resources.requests }}
                            requests:
                              {{- if .observed.composite.resource.spec.namespace.cas.resources.requests.memory }}
                              memory: {{ .observed.composite.resource.spec.namespace.cas.resources.requests.memory }}
                              {{- end }}
                              {{- if .observed.composite.resource.spec.gke.domain }}
                              ephemeral-storage: "30Gi"
                              {{- end }}
                            {{- end }}
                          {{- else }}
                          resources:
                            requests:
                              memory: 600Mi
                              {{- if .observed.composite.resource.spec.gke.domain }}
                              ephemeral-storage: "30Gi"
                              {{- end }}
                          {{- end }}
                      {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                      tolerations:
                      - effect: NoSchedule
                        key: nativelink/tolerates-spot
                        operator: Exists
                      - key: cloud.google.com/gke-spot
                        operator: Exists
                        effect: NoSchedule
                      - effect: NoSchedule
                        key: nativelink/not-disruptable
                        operator: Exists
                      {{- else }}
                      tolerations:
                      - effect: NoSchedule
                        key: nativelink/not-disruptable
                        operator: Exists
                      {{- end }}
                      volumes:
                        - name: config-json
                          configMap:
                            name: {{ or .observed.composite.resource.spec.namespace.cas.configMapName "cas-config" }}
                        - name: local-data
                          {{- if .observed.composite.resource.spec.namespace.cas.pvcStorageClass }}
                          persistentVolumeClaim:
                            claimName: cas-pvc
                          {{- else }}
                          emptyDir: {}
                          {{- end }}
                        - name: ca-certs
                          secret:
                            secretName: ca-certs
                            items:
                              - key: ca-certificates.crt
                                path: ca-certificates.crt
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: cas-service
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: Service
                metadata:
                  name: cas
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  labels:
                    nativelink: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                    app.kubernetes.io/name: cas
                spec:
                  selector:
                    app: cas
                  ports:
                    - name: grpc
                      protocol: TCP
                      port: 50051
                      targetPort: 50051
                    - name: metrics
                      protocol: TCP
                      port: 50061
                      targetPort: 50061
                   {{- if .observed.composite.resource.spec.namespace.bep.enabled }}
                    - name: bep
                      protocol: TCP
                      port: 50081
                      targetPort: 50081
                   {{- end }}
          {{- if gt .observed.composite.resource.spec.namespace.scheduler.replicas 0 }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: scheduler-config
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ConfigMap
                metadata:
                  name: scheduler-config
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                data:
                  scheduler.json: |
                    {
                      "schedulers": [
                        {
                          "name": "MAIN_SCHEDULER",
                          "property_modifier": {
                            "modifications": [
                              {
                                "add": {
                                  "name": "cpu_count",
                                  "value": "50"
                                }
                              }
                            ],
                            "scheduler": {
                              "simple": {
                                "experimental_backend": {
                                  "redis": {
                                    "redis_store": "SCHEDULER_REDIS_STORE"
                                  }
                                },
                                "supported_platform_properties": {
                                  "OSFamily": "priority",
                                  "container-image": "priority",
                                  "cpu_arch": "priority",
                                  "cpu_count": "minimum",
                                  "cpu_model": "priority",
                                  "cpu_vendor": "priority",
                                  "disk_read_bps": "priority",
                                  "disk_read_iops": "priority",
                                  "disk_write_bps": "priority",
                                  "disk_write_iops": "priority",
                                  "gpu_count": "priority",
                                  "gpu_model": "priority",
                                  "kernel_version": "priority",
                                  "lre-rs": "priority",
                                  "memory_kb": "priority",
                                  "network_kbps": "priority",
                                  "shm_size": "priority",
                                  "ISA": "exact"
                                }
                              }
                            }
                          }
                        }
                      ],
                      "servers": [
                        {
                          "listener": {
                            "http": {
                              "socket_address": "0.0.0.0:50052"
                            }
                          },
                          "services": {
                            "ac": {
                              "": {
                                "ac_store": "GRPC_LOCAL_AC_STORE"
                              },
                              "main": {
                                "ac_store": "GRPC_LOCAL_AC_STORE"
                              }
                            },
                            "capabilities": {
                              "": {
                                "remote_execution": {
                                  "scheduler": "MAIN_SCHEDULER"
                                }
                              },
                              "main": {
                                "remote_execution": {
                                  "scheduler": "MAIN_SCHEDULER"
                                }
                              }
                            },
                            "execution": {
                              "": {
                                "cas_store": "GRPC_LOCAL_STORE",
                                "scheduler": "MAIN_SCHEDULER"
                              },
                              "main": {
                                "cas_store": "GRPC_LOCAL_STORE",
                                "scheduler": "MAIN_SCHEDULER"
                              }
                            }
                          }
                        },
                        {
                          "listener": {
                            "http": {
                              "socket_address": "0.0.0.0:50061"
                            }
                          },
                          "services": {
                            "worker_api": {
                              "scheduler": "MAIN_SCHEDULER"
                            }
                          }
                        },
                        {
                          "listener": {
                            "http": {
                              "socket_address": "0.0.0.0:50062"
                            }
                          },
                          "services": {
                            "experimental_prometheus": {
                              "path": "/metrics"
                            },
                            "health": {}
                          }
                        }
                      ],
                      "stores": [
                        {
                          "grpc": {
                            "endpoints": [
                              {
                                "address": "grpc://${CAS_ENDPOINT:-127.0.0.1}:50051"
                              }
                            ],
                            "instance_name": "main",
                            "store_type": "ac"
                          },
                          "name": "GRPC_LOCAL_AC_STORE"
                        },
                        {
                          "grpc": {
                            "endpoints": [
                              {
                                "address": "grpc://${CAS_ENDPOINT:-127.0.0.1}:50051"
                              }
                            ],
                            "instance_name": "main",
                            "store_type": "cas"
                          },
                          "name": "GRPC_LOCAL_STORE"
                        },
                        {
                          "name": "SCHEDULER_REDIS_STORE",
                          "redis_store": {
                            "addresses": [
                              "${REDIS_SCHEDULER_URL}"
                            ],
                            "experimental_pub_sub_channel": "scheduler_key_change",
                            "mode": "{{ .observed.composite.resource.spec.namespace.cas.redisMode }}"
                          }
                        }
                      ]
                    }
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: scheduler-deployment
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  name: scheduler
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  labels:
                    nativelink: {{ .observed.composite.resource.spec.namespace.subdomain }}
                spec:
                  replicas: {{ .observed.composite.resource.spec.namespace.scheduler.replicas }}
                  selector:
                    matchLabels:
                      app: scheduler
                  template:
                    metadata:
                      annotations:
                        {{- if not .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                        "karpenter.sh/do-not-disrupt": "true"
                        cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
                        {{- end }}
                        "kubectl.kubernetes.io/default-container": "scheduler"
                      labels:
                        nativelink: {{ .observed.composite.resource.spec.namespace.subdomain }}
                        app: scheduler
                    spec:
                      terminationGracePeriodSeconds: 1800
                      priorityClassName: "nativelink-high-priority"
                      affinity:
                        podAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - weight: 100
                              podAffinityTerm:
                                labelSelector:
                                  matchExpressions:
                                    - key: nativelink
                                      operator: In
                                      values:
                                        - "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                                topologyKey: topology.kubernetes.io/zone
                      nodeSelector:
                        {{- if .observed.composite.resource.spec.eks.domain }}
                        {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                        node-role: "autoscaled-ondemand"
                        {{- else }}
                        node-role: "not-disruptable"
                        {{- end }}
                        {{- end }}
                        kubernetes.io/arch: "{{ .observed.composite.resource.spec.namespace.scheduler.cpuArch }}"
                        kubernetes.io/os: "linux"
                      serviceAccountName: "nativelink"
                      {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                      tolerations:
                      - effect: NoSchedule
                        key: nativelink/tolerates-spot
                        operator: Exists
                      - key: cloud.google.com/gke-spot
                        operator: Exists
                        effect: NoSchedule
                      - effect: NoSchedule
                        key: nativelink/not-disruptable
                        operator: Exists
                      {{- else }}
                      tolerations:
                      - effect: NoSchedule
                        key: nativelink/not-disruptable
                        operator: Exists
                      {{- end }}
                      containers:
                        - name: prom-metrics-filter
                          env:
                            - name: PROXY_PORT
                              value: "50062"
                          image: public.ecr.aws/b1l4l6w7/nl-ext/prom-metrics-filter:0.0.3
                          imagePullPolicy: Always
                          ports:
                            - containerPort: 8989
                              protocol: TCP
                        - image: {{ .observed.composite.resource.spec.namespace.nativeLinkImage }}
                          imagePullPolicy: {{ if contains "dkr.ecr" .observed.composite.resource.spec.namespace.nativeLinkImage }}Always{{ else }}IfNotPresent{{ end }}
                          name: scheduler
                          livenessProbe:
                            failureThreshold: 5
                            httpGet:
                              path: /status
                              port: 50062
                              scheme: HTTP
                            initialDelaySeconds: 5
                            periodSeconds: 10
                            successThreshold: 1
                            timeoutSeconds: 1
                          readinessProbe:
                            failureThreshold: 5
                            httpGet:
                              path: /status
                              port: 50062
                              scheme: HTTP
                            initialDelaySeconds: 5
                            periodSeconds: 10
                            successThreshold: 1
                            timeoutSeconds: 1
                          resources:
                            requests:
                              memory: 150Mi
                            limits:
                              memory: 300Mi
                          ports:
                            - containerPort: 50052
                              name: grpc
                            - containerPort: 50061
                              name: worker
                            - containerPort: 50062
                              name: metrics
                          args: ["/etc/config/scheduler.json"]
                          env:
                            - name: RUST_LOG
                              value: {{ .observed.composite.resource.spec.namespace.scheduler.rustLog }}
                            - name: CAS_ENDPOINT
                              value: "cas"
                            - name: NL_LOG
                              value: json
                            {{- range .observed.composite.resource.spec.namespace.scheduler.env }}
                            - name: {{ .name }}
                              value: {{ .value }}
                            {{- end }}
                          envFrom:
                            - configMapRef:
                                name: redis-env
                                optional: false
                          volumeMounts:
                            - name: config-json
                              mountPath: /etc/config
                      volumes:
                        - name: config-json
                          configMap:
                            name: {{ .observed.composite.resource.spec.namespace.scheduler.configMapName }}
          {{- end }}
  - step: patch-and-transform
    functionRef:
      name: crossplane-contrib-function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
        - name: scheduler-service
          base:
            apiVersion: kubernetes.crossplane.io/v1alpha1
            kind: Object
            spec:
              providerConfigRef:
                name: provider-config-kubernetes
              forProvider:
                manifest:
                  apiVersion: v1
                  kind: Service
                  metadata:
                    name: scheduler
                    labels:
                      app.kubernetes.io/name: scheduler
                  spec:
                    selector:
                      app: scheduler
                    ports:
                      - name: scheduler
                        protocol: TCP
                        port: 50052
                        targetPort: 50052
                      - name: worker-api
                        protocol: TCP
                        port: 50061
                        targetPort: 50061
                      - name: metrics
                        protocol: TCP
                        port: 50062
                        targetPort: 8989
          patches:
            - type: FromCompositeFieldPath
              fromFieldPath: metadata.labels["crossplane.io/claim-namespace"]
              toFieldPath: spec.forProvider.manifest.metadata.namespace
        - name: cas-service-monitor
          base:
            apiVersion: kubernetes.crossplane.io/v1alpha1
            kind: Object
            spec:
              providerConfigRef:
                name: provider-config-kubernetes
              forProvider:
                manifest:
                  apiVersion: monitoring.coreos.com/v1
                  kind: ServiceMonitor
                  metadata:
                    name: cas
                    namespace: ""
                  spec:
                    endpoints:
                      - path: /metrics
                        port: metrics
                    namespaceSelector:
                      matchNames:
                        - todo
                    selector:
                      matchLabels:
                        app.kubernetes.io/name: cas
          patches:
            - type: FromCompositeFieldPath
              fromFieldPath: metadata.labels["crossplane.io/claim-namespace"]
              toFieldPath: spec.forProvider.manifest.metadata.namespace
            - type: FromCompositeFieldPath
              fromFieldPath: metadata.labels["crossplane.io/claim-namespace"]
              toFieldPath: spec.forProvider.manifest.spec.namespaceSelector.matchNames[0]
        - name: scheduler-service-monitor
          base:
            apiVersion: kubernetes.crossplane.io/v1alpha1
            kind: Object
            spec:
              providerConfigRef:
                name: provider-config-kubernetes
              forProvider:
                manifest:
                  apiVersion: monitoring.coreos.com/v1
                  kind: ServiceMonitor
                  metadata:
                    name: scheduler
                    namespace: ""
                  spec:
                    endpoints:
                      - path: /metrics
                        port: metrics
                    namespaceSelector:
                      matchNames:
                        - todo
                    selector:
                      matchLabels:
                        app.kubernetes.io/name: scheduler
          patches:
            - type: FromCompositeFieldPath
              fromFieldPath: metadata.labels["crossplane.io/claim-namespace"]
              toFieldPath: spec.forProvider.manifest.metadata.namespace
            - type: FromCompositeFieldPath
              fromFieldPath: metadata.labels["crossplane.io/claim-namespace"]
              toFieldPath: spec.forProvider.manifest.spec.namespaceSelector.matchNames[0]
  - step: render-redis-template
    functionRef:
      name: crossplane-contrib-function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          {{- if not .observed.composite.resource.spec.namespace.redis.disabled }}
          {{- if .observed.composite.resource.spec.namespace.redis.volumeName }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: redis-existing-pvc
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: PersistentVolumeClaim
                metadata:
                  name: redis-data-redis-master-0
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  labels:
                    nativelink: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  accessModes:
                    - ReadWriteOnce
                  resources:
                    requests:
                      storage: {{ if eq .observed.composite.resource.spec.namespace.deployType "shared" }}3Gi{{else}}{{ or .observed.composite.resource.spec.namespace.redis.diskSize "12Gi" }}{{end}}
                  storageClassName: gp3-enc
                  volumeMode: Filesystem
                  volumeName: {{ .observed.composite.resource.spec.namespace.redis.volumeName }}
          {{- end }}
          ---
          apiVersion: helm.crossplane.io/v1beta1
          kind: Release
          metadata:
            name: redis-{{ .observed.composite.resource.spec.namespace.subdomain }}
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: redis
          spec:
            deletionPolicy: Delete
            forProvider:
              chart:
                name: redis
                {{- if .observed.composite.resource.spec.eks.domain }}
                url: https://api.{{ .observed.composite.resource.spec.eks.domain }}/files/redis-helm-19.1.1-9.tgz
                {{- else }}
                url: https://api.{{ .observed.composite.resource.spec.gke.domain }}/files/redis-helm-19.1.1-9.tgz
                {{- end }}
                version: 19.1.1-9
              namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
              skipCRDs: true
              skipCreateNamespace: true
              values:
                architecture: replication
                image:
                  {{- if .observed.composite.resource.spec.eks.domain }}
                  registry: "299166832260.dkr.ecr.us-east-2.amazonaws.com"
                  {{- else }}
                  registry: "us-docker.pkg.dev/native-link-cloud/aws-remote"
                  {{- end }}
                  repository: "redis-stack-server"
                  tag: "7.4.0-v0"
                auth:
                  enabled: false
                  sentinel: false
                fullnameOverride: redis
                useHostnames: true
                nameResolutionTimeout: 10
                replica:
                  replicaCount: {{ .observed.composite.resource.spec.namespace.redis.replicas }}
                  disableCommands: []
                  podLabels:
                    "nativelink": {{ .observed.composite.resource.spec.namespace.subdomain }}
                  extraFlags:
                    - --maxmemory-policy allkeys-lru
                    - --databases 4
                    {{- if .observed.composite.resource.spec.namespace.redis.maxMemory }}
                    - --maxmemory {{ .observed.composite.resource.spec.namespace.redis.maxMemory }}
                    {{- else }}
                    {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                    - --maxmemory 440mb
                    {{- else }}
                    - --maxmemory 620mb
                    {{- end }}
                    {{- end}}
                  persistence:
                    enabled: false
                    size: {{ if eq .observed.composite.resource.spec.namespace.deployType "shared" }}{{ or .observed.composite.resource.spec.namespace.redis.diskSize "6Gi" }}{{else}}{{ or .observed.composite.resource.spec.namespace.redis.diskSize "12Gi" }}{{end}}
                    storageClass: "gp3-enc"
                  {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                  nodeSelector:
                    kubernetes.io/os: "linux"
                    kubernetes.io/arch: arm64
                  tolerations:
                    - effect: NoSchedule
                      key: nativelink/not-disruptable
                      operator: Exists
                    - effect: NoSchedule
                      key: nativelink/tolerates-spot
                      operator: Exists
                    - key: cloud.google.com/gke-spot
                      operator: Exists
                      effect: NoSchedule
                  {{- else }}
                  priorityClassName: "nativelink-high-priority"
                  podAnnotations:
                    karpenter.sh/do-not-disrupt: "true"
                    cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
                  nodeSelector:
                    kubernetes.io/arch: arm64
                    kubernetes.io/os: "linux"
                    {{- if and (gt .observed.composite.resource.spec.namespace.redis.diskSize "19Gi") (not .observed.composite.resource.spec.gke.domain)  }}
                    node-role: not-disruptable-50g-ebs
                    {{- else }}
                    node-role: not-disruptable
                    {{- end }}
                  tolerations:
                    - effect: NoSchedule
                      key: nativelink/not-disruptable
                      operator: Exists
                  {{- end }}
                  {{- if .observed.composite.resource.spec.namespace.redis.resources }}
                  resources:
                    {{- if .observed.composite.resource.spec.namespace.redis.resources.limits }}
                    limits:
                      {{- if .observed.composite.resource.spec.namespace.redis.resources.limits.memory }}
                      memory: {{ .observed.composite.resource.spec.namespace.redis.resources.limits.memory }}
                      {{- end }}
                      ephemeral-storage: {{ or .observed.composite.resource.spec.namespace.redis.diskSize "10Gi" }}
                    {{- end }}
                    {{- if .observed.composite.resource.spec.namespace.redis.resources.requests }}
                    requests:
                      {{- if .observed.composite.resource.spec.namespace.redis.resources.requests.memory }}
                      memory: {{ .observed.composite.resource.spec.namespace.redis.resources.requests.memory }}
                      {{- end }}
                      ephemeral-storage: {{ or .observed.composite.resource.spec.namespace.redis.diskSize "10Gi" }}
                    {{- end }}
                  {{- else }}
                  resources:
                    {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                    requests:
                      ephemeral-storage: 1Gi
                      memory: 500Mi
                    {{- else }}
                    requests:
                      ephemeral-storage: 1Gi
                      memory: 700Mi
                    {{- end }}
                  {{- end }}
                  affinity:
                    {{- if .observed.composite.resource.spec.namespace.cas.toleratesSpot }}
                    {{- if .observed.composite.resource.spec.eks.awsAccountID }}
                    nodeAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - preference:
                            matchExpressions:
                              - key: eks.amazonaws.com/capacityType
                                operator: In
                                values:
                                  - SPOT
                          weight: 100
                    {{- end }}
                    {{- if .observed.composite.resource.spec.gke.domain }}
                    nodeAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - preference:
                            matchExpressions:
                              - key: cloud.google.com/gke-spot
                                operator: In
                                values:
                                  - "true"
                          weight: 100
                    {{- end }}
                    {{- end }}
                    podAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 100
                          podAffinityTerm:
                            labelSelector:
                              matchExpressions:
                                - key: nativelink
                                  operator: In
                                  values:
                                    - {{ .observed.composite.resource.spec.namespace.subdomain }}
                            topologyKey: topology.kubernetes.io/zone
                metrics:
                  enabled: true
                  resources:
                    limits:
                      ephemeral-storage: 1Gi
                      memory: 192Mi
                    requests:
                      ephemeral-storage: 50Mi
                      memory: 80Mi
                  serviceMonitor:
                    enabled: true
                nameOverride: redis
                networkPolicy:
                  enabled: false
                sentinel:
                  enabled: true
                  debug: true
                  {{- if eq .observed.composite.resource.spec.namespace.deployType "dedicated" }}
                  quorum: 2
                  {{- else }}
                  quorum: 1
                  {{- end }}
                  masterSet: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
              wait: false
            managementPolicies:
              - '*'
            providerConfigRef:
              name: provider-config-helm
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: redis-pdb
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: policy/v1
                kind: PodDisruptionBudget
                metadata:
                  name: redis-pdb
                  namespace: nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}
                spec:
                  maxUnavailable: 1
                  selector:
                    matchLabels:
                      app.kubernetes.io/name: redis
                      "nativelink": {{ .observed.composite.resource.spec.namespace.subdomain }}
          {{- end }}
  - step: render-ingress-template
    functionRef:
      name: crossplane-contrib-function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          {{- if ne .observed.composite.resource.spec.namespace.deployState "deactivated" }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: ingress
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: networking.k8s.io/v1
                kind: Ingress
                metadata:
                  annotations:
                    nginx.ingress.kubernetes.io/ssl-redirect: "true"
                    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
                    nginx.ingress.kubernetes.io/proxy-body-size: "0"
                    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
                    nginx.ingress.kubernetes.io/proxy-send-timeout: "1800"
                    nginx.ingress.kubernetes.io/proxy-read-timeout: "1800"
                    nginx.ingress.kubernetes.io/auth-cache-duration: 401 403 10s, 200 201 202 1m
                    nginx.ingress.kubernetes.io/auth-cache-key: $http_authorization$request_uri
                    nginx.ingress.kubernetes.io/auth-url: "http://api.nativelink-api.svc.cluster.local:8000/api-auth/v1/verify-api-key/{{.observed.composite.resource.spec.namespace.accountId}}"
                    {{- if .observed.composite.resource.spec.namespace.ingressAuthTLSSecret }}
                    nginx.ingress.kubernetes.io/auth-tls-secret: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}/{{ .observed.composite.resource.spec.namespace.ingressAuthTLSSecret }}"
                    nginx.ingress.kubernetes.io/auth-tls-verify-client: optional
                    {{- end }}
                    {{- if .observed.composite.resource.spec.namespace.rpsRateLimit }}
                    nginx.ingress.kubernetes.io/limit-rps: "{{ .observed.composite.resource.spec.namespace.rpsRateLimit }}"
                    {{- end }}
                    {{- if .observed.composite.resource.spec.namespace.perIpConnectionLimit }}
                    nginx.ingress.kubernetes.io/limit-connections: "{{ .observed.composite.resource.spec.namespace.perIpConnectionLimit }}"
                    {{- end }}
                    {{- if .observed.composite.resource.spec.eks.clusterIssuer }}
                    cert-manager.io/cluster-issuer: "{{ .observed.composite.resource.spec.eks.clusterIssuer }}"
                    {{- else }}
                    cert-manager.io/cluster-issuer: "{{ .observed.composite.resource.spec.gke.clusterIssuer }}"
                    {{- end }}
                  labels:
                    nativelink-account: {{ .observed.composite.resource.spec.namespace.accountId }}
                  name: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  ingressClassName: nginx
                  rules:
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "cas-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "cas-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: cas
                                port:
                                  number: 50051
                            path: /
                            pathType: Prefix
                    {{- if .observed.composite.resource.spec.namespace.alias }}
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "cas-{{ .observed.composite.resource.spec.namespace.alias }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "cas-{{ .observed.composite.resource.spec.namespace.alias }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: cas
                                port:
                                  number: 50051
                            path: /
                            pathType: Prefix
                    {{- end }}
                    {{- if gt .observed.composite.resource.spec.namespace.scheduler.replicas 0 }}
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "scheduler-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "scheduler-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: scheduler
                                port:
                                  number: 50052
                            path: /
                            pathType: Prefix
                    {{- if .observed.composite.resource.spec.namespace.scheduler.workersIngress }}
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "workers-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "workers-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: scheduler
                                port:
                                  number: 50061
                            path: /
                            pathType: Prefix
                    {{- end }}
                    {{- if .observed.composite.resource.spec.namespace.alias }}
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "scheduler-{{ .observed.composite.resource.spec.namespace.alias }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "scheduler-{{ .observed.composite.resource.spec.namespace.alias }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: scheduler
                                port:
                                  number: 50052
                            path: /
                            pathType: Prefix
                    {{- end }}
                    {{- end }}
                    {{- if .observed.composite.resource.spec.namespace.bep.enabled }}
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "bes-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "bes-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: cas
                                port:
                                  number: 50081
                            path: /
                            pathType: Prefix
                    {{- if .observed.composite.resource.spec.namespace.alias }}
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "bes-{{ .observed.composite.resource.spec.namespace.alias }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "bes-{{ .observed.composite.resource.spec.namespace.alias }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: cas
                                port:
                                  number: 50081
                            path: /
                            pathType: Prefix
                    {{- end }}
                    {{- end }}
                  tls:
                    - hosts:
                      {{ range .observed.composite.resource.spec.namespace.ingressTLSHosts }}
                      - "{{.}}"
                      {{ end }}
                      secretName: nativelink-tls
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: grafana-dashboard
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                data:
                  nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}.json: |-
                    {
                      "annotations": {
                        "list": [
                          {
                            "builtIn": 1,
                            "datasource": {
                              "type": "grafana",
                              "uid": "-- Grafana --"
                            },
                            "enable": true,
                            "hide": true,
                            "iconColor": "rgba(0, 211, 255, 1)",
                            "name": "Annotations & Alerts",
                            "type": "dashboard"
                          }
                        ]
                      },
                      "description": "",
                      "editable": true,
                      "fiscalYearStartMonth": 0,
                      "graphTooltip": 0,
                      "links": [],
                      "liveNow": false,
                      "panels": [
                        {
                            "datasource": {
                              "type": "elasticsearch", "uid": "k8sevents"
                            },
                            "description": "Infrastructure events related to your deployment in NativeLink cloud.",
                            "fieldConfig": {
                              "defaults": {},
                              "overrides": []
                            },
                            "gridPos": {
                              "h": 10,
                              "w": 14,
                              "x": 10,
                              "y": 71
                            },
                            "id": 38,
                            "options": {
                              "dedupStrategy": "none",
                              "enableInfiniteScrolling": false,
                              "enableLogDetails": true,
                              "prettifyLogMessage": false,
                              "showCommonLabels": false,
                              "showLabels": false,
                              "showTime": true,
                              "sortOrder": "Descending",
                              "wrapLogMessage": false
                            },
                            "pluginVersion": "12.0.0",
                            "targets": [
                              {
                                "alias": "",
                                "bucketAggs": [
                                  {
                                    "field": "@timestamp",
                                    "id": "2",
                                    "settings": {
                                      "interval": "auto"
                                    },
                                    "type": "date_histogram"
                                  }
                                ],
                                "datasource": {
                                  "type": "elasticsearch", "uid": "k8sevents"
                                },
                                "metrics": [
                                  {
                                    "id": "1",
                                    "type": "logs"
                                  }
                                ],
                                "query": "namespace.keyword: \"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"",
                                "refId": "A",
                                "timeField": "@timestamp"
                              }
                            ],
                            "title": "Infrastructure Events",
                            "type": "logs"
                        },
                        {
                          "collapsed": false,
                          "gridPos": {
                            "h": 1,
                            "w": 24,
                            "x": 0,
                            "y": 0
                          },
                          "id": 19,
                          "panels": [],
                          "title": "Resources",
                          "type": "row"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 1,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "normal"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 0,
                            "y": 1
                          },
                          "id": 25,
                          "options": {
                            "legend": {
                              "calcs": [
                                "last"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "exemplar": true,
                              "expr": "sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}\n* on(namespace,pod)\n  group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}\n) by (workload, workload_type)",
                              "interval": "",
                              "legendFormat": "{{ `{{` }}workload{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "CPU Usage",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "series",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": true,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "min": 0,
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "bytes",
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 12,
                            "y": 1
                          },
                          "id": 7,
                          "interval": "1m",
                          "links": [],
                          "options": {
                            "legend": {
                              "calcs": [],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "pluginVersion": "10.1.5",
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(container_memory_working_set_bytes{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", container!=\"filter\", container!=\"\", image!=\"\"}) by (container)",
                              "format": "time_series",
                              "intervalFactor": 2,
                              "legendFormat": "{{ `{{` }}container{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "Memory Usage",
                          "type": "timeseries"
                        },
                        {
                          "collapsed": false,
                          "gridPos": {
                            "h": 1,
                            "w": 24,
                            "x": 0,
                            "y": 9
                          },
                          "id": 18,
                          "panels": [],
                          "title": "Network",
                          "type": "row"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": true,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "reqps",
                              "unitScale": true
                            },
                            "overrides": [
                              {
                                "matcher": {
                                  "id": "byValue",
                                  "options": {
                                    "op": "gte",
                                    "reducer": "allIsZero",
                                    "value": 0
                                  }
                                },
                                "properties": [
                                  {
                                    "id": "custom.hideFrom",
                                    "value": {
                                      "legend": true,
                                      "tooltip": true,
                                      "viz": false
                                    }
                                  }
                                ]
                              }
                            ]
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 0,
                            "y": 10
                          },
                          "id": 11,
                          "links": [],
                          "options": {
                            "legend": {
                              "calcs": [
                                "mean"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true,
                              "width": 300
                            },
                            "tooltip": {
                              "mode": "multi",
                              "sort": "desc"
                            }
                          },
                          "pluginVersion": "10.1.5",
                          "repeatDirection": "h",
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "round(sum(irate(nginx_ingress_controller_requests{ingress=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[1m])) by (ingress), 0.001)",
                              "format": "time_series",
                              "hide": false,
                              "instant": false,
                              "interval": "",
                              "intervalFactor": 1,
                              "legendFormat": "{{ `{{` }}ingress{{ `}}` }}",
                              "metric": "network",
                              "refId": "A",
                              "step": 10
                            }
                          ],
                          "title": "Ingress Request Volume",
                          "type": "timeseries"
                        },
                        {
                          "aliasColors": {
                            "max - istio-proxy": "#890f02",
                            "max - master": "#bf1b00",
                            "max - prometheus": "#bf1b00"
                          },
                          "bars": false,
                          "dashLength": 10,
                          "dashes": false,
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "decimals": 2,
                          "editable": false,
                          "error": false,
                          "fieldConfig": {
                            "defaults": {
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "fill": 0,
                          "fillGradient": 0,
                          "grid": {},
                          "gridPos": {
                            "h": 7,
                            "w": 12,
                            "x": 12,
                            "y": 10
                          },
                          "hiddenSeries": false,
                          "id": 31,
                          "legend": {
                            "alignAsTable": false,
                            "avg": true,
                            "current": false,
                            "hideEmpty": true,
                            "hideZero": false,
                            "max": false,
                            "min": false,
                            "rightSide": false,
                            "show": true,
                            "sideWidth": 300,
                            "sort": "avg",
                            "sortDesc": true,
                            "total": false,
                            "values": true
                          },
                          "lines": true,
                          "linewidth": 2,
                          "links": [],
                          "nullPointMode": "connected",
                          "options": {
                            "alertThreshold": true
                          },
                          "percentage": false,
                          "pluginVersion": "10.3.3",
                          "pointradius": 5,
                          "points": false,
                          "renderer": "flot",
                          "seriesOverrides": [],
                          "spaceLength": 10,
                          "stack": false,
                          "steppedLine": false,
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(rate(nginx_ingress_controller_requests{ingress=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\",status!~\"[4-5].*\"}[2m])) by (ingress) / sum(rate(nginx_ingress_controller_requests{ingress=~\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[2m])) by (ingress)",
                              "format": "time_series",
                              "instant": false,
                              "interval": "10s",
                              "intervalFactor": 1,
                              "legendFormat": "{{ `{{` }}ingress{{ `}}` }}",
                              "metric": "container_memory_usage:sort_desc",
                              "refId": "A",
                              "step": 10
                            }
                          ],
                          "thresholds": [],
                          "timeRegions": [],
                          "title": "Ingress Success Rate (non-4|5xx responses)",
                          "tooltip": {
                            "msResolution": false,
                            "shared": true,
                            "sort": 1,
                            "value_type": "cumulative"
                          },
                          "type": "graph",
                          "xaxis": {
                            "mode": "time",
                            "show": true,
                            "values": []
                          },
                          "yaxes": [
                            {
                              "$$hashKey": "object:130",
                              "format": "percentunit",
                              "logBase": 1,
                              "show": true
                            },
                            {
                              "$$hashKey": "object:131",
                              "format": "short",
                              "logBase": 1,
                              "show": false
                            }
                          ],
                          "yaxis": {
                            "align": false
                          }
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "series",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 13,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": true,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "min": 0,
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "Bps",
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 12,
                            "y": 17
                          },
                          "id": 9,
                          "interval": "1m",
                          "links": [],
                          "options": {
                            "legend": {
                              "calcs": [],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "pluginVersion": "10.1.5",
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(irate(container_network_transmit_bytes_total{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", pod!~\"builder.*\"}[$__rate_interval])) by (pod)",
                              "format": "time_series",
                              "intervalFactor": 2,
                              "legendFormat": "{{ `{{` }}pod{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "Transmit Bandwidth",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "min": 0,
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "Bps",
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 7,
                            "w": 12,
                            "x": 0,
                            "y": 18
                          },
                          "id": 10,
                          "interval": "1m",
                          "links": [],
                          "options": {
                            "legend": {
                              "calcs": [],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "pluginVersion": "10.1.5",
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(irate(container_network_receive_bytes_total{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", pod!~\"builder.*\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[$__rate_interval])) by (pod)",
                              "format": "time_series",
                              "intervalFactor": 2,
                              "legendFormat": "{{ `{{` }}pod{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "Receive Bandwidth",
                          "type": "timeseries"
                        },
                        {
                          "collapsed": false,
                          "gridPos": {
                            "h": 1,
                            "w": 24,
                            "x": 0,
                            "y": 25
                          },
                          "id": 16,
                          "panels": [],
                          "title": "CAS",
                          "type": "row"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "bytes",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 3,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "auto",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  }
                                ]
                              },
                              "unit": "bytes",
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 0,
                            "y": 26
                          },
                          "id": 2,
                          "options": {
                            "legend": {
                              "calcs": [],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "targets": [
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "nativelink_stores_AC_FAST_SLOW_STORE_fast_store_lower_store_evicting_map_sum_store_size{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "Store Size (bytes)",
                              "range": true,
                              "refId": "B"
                            }
                          ],
                          "title": "Action Cache Size",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 0,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 1,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "auto",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "bytes",
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 12,
                            "y": 26
                          },
                          "id": 4,
                          "options": {
                            "legend": {
                              "calcs": [],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "targets": [
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "nativelink_stores_CAS_FAST_SLOW_STORE_inner_store_fast_store_lower_store_evicting_map_sum_store_size{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "Fast In-Memory Max",
                              "range": true,
                              "refId": "B"
                            }
                          ],
                          "title": "CAS Fast In-Memory Size",
                          "type": "timeseries"
                        },
                        {
                          "aliasColors": {},
                          "bars": false,
                          "dashLength": 10,
                          "dashes": false,
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "description": "db0 = ActionCache, db1 = CAS, db2 = BEP",
                          "editable": true,
                          "error": false,
                          "fieldConfig": {
                            "defaults": {
                              "links": [],
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "fill": 7,
                          "fillGradient": 0,
                          "grid": {},
                          "gridPos": {
                            "h": 7,
                            "w": 12,
                            "x": 0,
                            "y": 34
                          },
                          "hiddenSeries": false,
                          "id": 32,
                          "legend": {
                            "alignAsTable": true,
                            "avg": false,
                            "current": true,
                            "max": false,
                            "min": false,
                            "rightSide": true,
                            "show": true,
                            "total": false,
                            "values": true
                          },
                          "lines": true,
                          "linewidth": 2,
                          "links": [],
                          "nullPointMode": "connected",
                          "options": {
                            "alertThreshold": true
                          },
                          "percentage": false,
                          "pluginVersion": "10.3.3",
                          "pointradius": 5,
                          "points": false,
                          "renderer": "flot",
                          "seriesOverrides": [],
                          "spaceLength": 10,
                          "stack": true,
                          "steppedLine": false,
                          "targets": [
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "sum (redis_db_keys{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}) by (db)",
                              "format": "time_series",
                              "interval": "",
                              "intervalFactor": 2,
                              "legendFormat": "{{ `{{` }} db }} ",
                              "range": true,
                              "refId": "A",
                              "step": 240,
                              "target": ""
                            }
                          ],
                          "thresholds": [],
                          "timeRegions": [],
                          "title": "Items in Redis by DB",
                          "tooltip": {
                            "msResolution": false,
                            "shared": true,
                            "sort": 0,
                            "value_type": "individual"
                          },
                          "type": "graph",
                          "xaxis": {
                            "mode": "time",
                            "show": true,
                            "values": []
                          },
                          "yaxes": [
                            {
                              "format": "none",
                              "logBase": 1,
                              "show": true
                            },
                            {
                              "format": "short",
                              "logBase": 1,
                              "show": true
                            }
                          ],
                          "yaxis": {
                            "align": false
                          }
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "description": "",
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 0,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": true,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "links": [],
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "none",
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 7,
                            "w": 12,
                            "x": 12,
                            "y": 34
                          },
                          "id": 34,
                          "links": [],
                          "options": {
                            "legend": {
                              "calcs": [
                                "lastNotNull"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "multi",
                              "sort": "none"
                            }
                          },
                          "pluginVersion": "10.3.3",
                          "targets": [
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "nativelink_stores_AC_FAST_SLOW_STORE_fast_store_hit_count{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}",
                              "format": "time_series",
                              "interval": "",
                              "intervalFactor": 2,
                              "legendFormat": "AC Fast Store Hits",
                              "range": true,
                              "refId": "A",
                              "step": 240,
                              "target": ""
                            },
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "nativelink_stores_AC_FAST_SLOW_STORE_slow_store_hit_count{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "AC Slow Store Hits",
                              "range": true,
                              "refId": "B"
                            },
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "nativelink_stores_CAS_FAST_SLOW_STORE_inner_store_fast_store_hit_count{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "CAS Fast Store Hits",
                              "range": true,
                              "refId": "C"
                            },
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "nativelink_stores_CAS_FAST_SLOW_STORE_inner_store_slow_store_hit_count{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "CAS Slow Store Hits",
                              "range": true,
                              "refId": "D"
                            }
                          ],
                          "title": "AC / CAS Hit Counts",
                          "type": "timeseries"
                        },
                        {
                          "collapsed": false,
                          "gridPos": {
                            "h": 1,
                            "w": 24,
                            "x": 0,
                            "y": 41
                          },
                          "id": 17,
                          "panels": [],
                          "title": "Remote Execution",
                          "type": "row"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": true,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "none",
                              "unitScale": true
                            },
                            "overrides": [
                              {
                                "matcher": {
                                  "id": "byValue",
                                  "options": {
                                    "op": "gte",
                                    "reducer": "allIsZero",
                                    "value": 0
                                  }
                                },
                                "properties": [
                                  {
                                    "id": "custom.hideFrom",
                                    "value": {
                                      "legend": true,
                                      "tooltip": true,
                                      "viz": false
                                    }
                                  }
                                ]
                              }
                            ]
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 8,
                            "x": 0,
                            "y": 42
                          },
                          "id": 20,
                          "links": [],
                          "options": {
                            "legend": {
                              "calcs": [
                                "mean"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true,
                              "width": 300
                            },
                            "tooltip": {
                              "mode": "multi",
                              "sort": "desc"
                            }
                          },
                          "pluginVersion": "10.1.5",
                          "repeatDirection": "h",
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum by (container_image) (scale_up_queued_tasks_per_image{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"})",
                              "format": "time_series",
                              "hide": false,
                              "instant": false,
                              "interval": "",
                              "intervalFactor": 1,
                              "legendFormat": "{{ `{{` }}container_image{{ `}}` }}",
                              "metric": "network",
                              "refId": "A",
                              "step": 10
                            }
                          ],
                          "title": "Queued Tasks per Container Image",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 1,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "normal"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 8,
                            "x": 8,
                            "y": 42
                          },
                          "id": 23,
                          "options": {
                            "legend": {
                              "calcs": [
                                "last"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "exemplar": true,
                              "expr": "scale_up_queued_tasks{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}",
                              "interval": "",
                              "legendFormat": "Task Count",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "Queued Tasks",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 2,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": true,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unit": "none",
                              "unitScale": true
                            },
                            "overrides": [
                              {
                                "matcher": {
                                  "id": "byValue",
                                  "options": {
                                    "op": "gte",
                                    "reducer": "allIsZero",
                                    "value": 0
                                  }
                                },
                                "properties": [
                                  {
                                    "id": "custom.hideFrom",
                                    "value": {
                                      "legend": true,
                                      "tooltip": true,
                                      "viz": false
                                    }
                                  }
                                ]
                              }
                            ]
                          },
                          "gridPos": {
                            "h": 8,
                            "w": 8,
                            "x": 16,
                            "y": 42
                          },
                          "id": 22,
                          "links": [],
                          "options": {
                            "legend": {
                              "calcs": [
                                "mean"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true,
                              "width": 300
                            },
                            "tooltip": {
                              "mode": "multi",
                              "sort": "desc"
                            }
                          },
                          "pluginVersion": "10.1.5",
                          "repeatDirection": "h",
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum by (namespace) (irate(nativelink_workers_worker_0_execute_successes{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[1m]))",
                              "format": "time_series",
                              "hide": false,
                              "instant": false,
                              "interval": "",
                              "intervalFactor": 1,
                              "legendFormat": "Execute Successes",
                              "metric": "network",
                              "refId": "A",
                              "step": 10
                            },
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "sum by (namespace) (irate(nativelink_workers_worker_0_task_timeouts_counter{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[1m]))",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "Timeouts",
                              "range": true,
                              "refId": "B"
                            },
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "sum by (namespace) (irate(nativelink_workers_worker_0_execute_failures{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[1m]))",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "Execute Failures",
                              "range": true,
                              "refId": "C"
                            }
                          ],
                          "title": "Tasks (1-min rate)",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 0,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 1,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "auto",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "none"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 10,
                            "w": 8,
                            "x": 0,
                            "y": 50
                          },
                          "id": 37,
                          "options": {
                            "legend": {
                              "calcs": [],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "targets": [
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "sum by (namespace) (increase(nativelink_action_schedulers_MAIN_SCHEDULER_worker_run_action_successes{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[1m]))",
                              "instant": false,
                              "legendFormat": "Successes",
                              "range": true,
                              "refId": "A"
                            },
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "sum by (namespace) (increase(nativelink_action_schedulers_MAIN_SCHEDULER_worker_run_action_failures{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[1m]))",
                              "hide": false,
                              "instant": false,
                              "legendFormat": "Failures",
                              "range": true,
                              "refId": "B"
                            }
                          ],
                          "title": "Scheduler Actions",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 1,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "normal"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 10,
                            "w": 9,
                            "x": 8,
                            "y": 50
                          },
                          "id": 21,
                          "options": {
                            "legend": {
                              "calcs": [
                                "last"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "exemplar": true,
                              "expr": "sum by(phase)(karpenter_pods_state{exported_namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\",name=~\"worker.*\"})",
                              "interval": "",
                              "legendFormat": "{{ `{{` }}label_name{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "Worker Pods",
                          "type": "timeseries"
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "axisBorderShow": false,
                                "axisCenteredZero": false,
                                "axisColorMode": "text",
                                "axisLabel": "",
                                "axisPlacement": "auto",
                                "barAlignment": 0,
                                "drawStyle": "line",
                                "fillOpacity": 10,
                                "gradientMode": "none",
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                },
                                "insertNulls": false,
                                "lineInterpolation": "linear",
                                "lineWidth": 1,
                                "pointSize": 5,
                                "scaleDistribution": {
                                  "type": "linear"
                                },
                                "showPoints": "never",
                                "spanNulls": false,
                                "stacking": {
                                  "group": "A",
                                  "mode": "normal"
                                },
                                "thresholdsStyle": {
                                  "mode": "off"
                                }
                              },
                              "mappings": [],
                              "thresholds": {
                                "mode": "absolute",
                                "steps": [
                                  {
                                    "color": "green",
                                    "value": null
                                  },
                                  {
                                    "color": "red",
                                    "value": 80
                                  }
                                ]
                              },
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 10,
                            "w": 7,
                            "x": 17,
                            "y": 50
                          },
                          "id": 33,
                          "options": {
                            "legend": {
                              "calcs": [
                                "last"
                              ],
                              "displayMode": "list",
                              "placement": "bottom",
                              "showLegend": true
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "exemplar": true,
                              "expr": "sum by(worker_hash)(rate(scale_up_pods_added_per_hash_count{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\"}[$__rate_interval]))",
                              "interval": "",
                              "legendFormat": "{{ `{{` }}label_name{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "Scale-up Rate (per Hash)",
                          "type": "timeseries"
                        },
                        {
                          "aliasColors": {},
                          "bars": false,
                          "dashLength": 10,
                          "dashes": false,
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "fill": 10,
                          "fillGradient": 0,
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 0,
                            "y": 60
                          },
                          "hiddenSeries": false,
                          "id": 26,
                          "interval": "1m",
                          "legend": {
                            "alignAsTable": false,
                            "avg": false,
                            "current": false,
                            "max": false,
                            "min": false,
                            "rightSide": false,
                            "show": true,
                            "total": false,
                            "values": false
                          },
                          "lines": true,
                          "linewidth": 0,
                          "links": [],
                          "nullPointMode": "null as zero",
                          "options": {
                            "alertThreshold": true
                          },
                          "percentage": false,
                          "pluginVersion": "10.3.3",
                          "pointradius": 5,
                          "points": false,
                          "renderer": "flot",
                          "seriesOverrides": [
                            {
                              "alias": "requests",
                              "color": "#F2495C",
                              "fill": 0,
                              "hideTooltip": true,
                              "legend": true,
                              "linewidth": 2,
                              "stack": false
                            },
                            {
                              "alias": "limits",
                              "color": "#FF9830",
                              "fill": 0,
                              "hideTooltip": true,
                              "legend": true,
                              "linewidth": 2,
                              "stack": false
                            }
                          ],
                          "spaceLength": 10,
                          "stack": true,
                          "steppedLine": false,
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", container=\"worker\"}) by (container)",
                              "format": "time_series",
                              "legendFormat": "{{ `{{` }}container{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            },
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(kube_pod_container_resource_requests{job=\"kube-state-metrics\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", container=\"worker\", resource=\"cpu\"}\n)\n",
                              "format": "time_series",
                              "legendFormat": "requests",
                              "range": true,
                              "refId": "B"
                            },
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(kube_pod_container_resource_limits{job=\"kube-state-metrics\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", container=\"worker\", resource=\"cpu\"}\n)\n",
                              "format": "time_series",
                              "legendFormat": "limits",
                              "range": true,
                              "refId": "C"
                            }
                          ],
                          "thresholds": [],
                          "timeRegions": [],
                          "title": "Worker CPU Usage / Requests / Limits",
                          "tooltip": {
                            "shared": false,
                            "sort": 2,
                            "value_type": "individual"
                          },
                          "type": "graph",
                          "xaxis": {
                            "mode": "time",
                            "show": true,
                            "values": []
                          },
                          "yaxes": [
                            {
                              "$$hashKey": "object:17",
                              "format": "short",
                              "logBase": 1,
                              "min": 0,
                              "show": true
                            },
                            {
                              "$$hashKey": "object:18",
                              "format": "short",
                              "logBase": 1,
                              "show": false
                            }
                          ],
                          "yaxis": {
                            "align": false
                          }
                        },
                        {
                          "aliasColors": {},
                          "bars": false,
                          "dashLength": 10,
                          "dashes": false,
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "fieldConfig": {
                            "defaults": {
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "fill": 10,
                          "fillGradient": 0,
                          "gridPos": {
                            "h": 8,
                            "w": 12,
                            "x": 12,
                            "y": 60
                          },
                          "hiddenSeries": false,
                          "id": 27,
                          "interval": "1m",
                          "legend": {
                            "alignAsTable": false,
                            "avg": false,
                            "current": false,
                            "max": false,
                            "min": false,
                            "rightSide": false,
                            "show": true,
                            "total": false,
                            "values": false
                          },
                          "lines": true,
                          "linewidth": 0,
                          "links": [],
                          "nullPointMode": "null as zero",
                          "options": {
                            "alertThreshold": true
                          },
                          "percentage": false,
                          "pluginVersion": "10.3.3",
                          "pointradius": 5,
                          "points": false,
                          "renderer": "flot",
                          "seriesOverrides": [
                            {
                              "alias": "requests",
                              "color": "#F2495C",
                              "dashes": true,
                              "fill": 0,
                              "hideTooltip": true,
                              "legend": true,
                              "linewidth": 2,
                              "stack": false
                            },
                            {
                              "alias": "limits",
                              "color": "#FF9830",
                              "dashes": true,
                              "fill": 0,
                              "hideTooltip": true,
                              "legend": true,
                              "linewidth": 2,
                              "stack": false
                            }
                          ],
                          "spaceLength": 10,
                          "stack": true,
                          "steppedLine": false,
                          "targets": [
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(container_memory_working_set_bytes{job=\"kubelet\", metrics_path=\"/metrics/cadvisor\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", container=\"worker\", image!=\"\"}) by (container)",
                              "format": "time_series",
                              "legendFormat": "{{ `{{` }}container{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            },
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(kube_pod_container_resource_requests{job=\"kube-state-metrics\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", container=\"worker\", resource=\"memory\"}\n)\n",
                              "format": "time_series",
                              "legendFormat": "requests",
                              "range": true,
                              "refId": "B"
                            },
                            {
                              "datasource": {
                                "uid": "$datasource"
                              },
                              "editorMode": "code",
                              "expr": "sum(kube_pod_container_resource_limits{job=\"kube-state-metrics\", namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", container=\"worker\", resource=\"memory\"}\n)\n",
                              "format": "time_series",
                              "legendFormat": "limits",
                              "range": true,
                              "refId": "C"
                            }
                          ],
                          "thresholds": [],
                          "timeRegions": [],
                          "title": "Worker Memory Usage / Requests / Limits",
                          "tooltip": {
                            "shared": false,
                            "sort": 2,
                            "value_type": "individual"
                          },
                          "type": "graph",
                          "xaxis": {
                            "mode": "time",
                            "show": true,
                            "values": []
                          },
                          "yaxes": [
                            {
                              "$$hashKey": "object:177",
                              "format": "bytes",
                              "logBase": 1,
                              "min": 0,
                              "show": true
                            },
                            {
                              "$$hashKey": "object:178",
                              "format": "short",
                              "logBase": 1,
                              "show": false
                            }
                          ],
                          "yaxis": {
                            "align": false
                          }
                        },
                        {
                          "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus"
                          },
                          "description": "Link to Node Exporter full dashboard for nodes that are hosting workers in this claim.",
                          "fieldConfig": {
                            "defaults": {
                              "color": {
                                "mode": "palette-classic"
                              },
                              "custom": {
                                "hideFrom": {
                                  "legend": false,
                                  "tooltip": false,
                                  "viz": false
                                }
                              },
                              "links": [
                                {
                                  "targetBlank": true,
                                  "title": "Worker Node Metrics",
                                  {{- if .observed.composite.resource.spec.gke.domain }}
                                  "url": "https://grafana.{{ .observed.composite.resource.spec.gke.domain }}/d/node-exporter-full?orgId=1&refresh=1m&var-datasource=default&var-job=node-exporter&var-node=${__field.labels.instance}"
                                  {{- else }}
                                  "url": "https://grafana.{{ .observed.composite.resource.spec.eks.domain }}/d/node-exporter-full?orgId=1&refresh=1m&var-datasource=default&var-job=node-exporter&var-node=${__field.labels.instance}"
                                  {{- end }}
                                }
                              ],
                              "mappings": [],
                              "unitScale": true
                            },
                            "overrides": []
                          },
                          "gridPos": {
                            "h": 10,
                            "w": 10,
                            "x": 0,
                            "y": 68
                          },
                          "id": 35,
                          "options": {
                            "displayLabels": [],
                            "legend": {
                              "displayMode": "table",
                              "placement": "right",
                              "showLegend": true
                            },
                            "pieType": "donut",
                            "reduceOptions": {
                              "calcs": [
                                "lastNotNull"
                              ],
                              "fields": "",
                              "values": false
                            },
                            "tooltip": {
                              "mode": "single",
                              "sort": "none"
                            }
                          },
                          "pluginVersion": "10.3.3",
                          "targets": [
                            {
                              "datasource": {
                                "type": "prometheus",
                                "uid": "prometheus"
                              },
                              "editorMode": "code",
                              "expr": "count by (node) (node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate{namespace=\"nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}\", pod=~\"worker.*\", pod!~\"worker-provisioner.*\"}) * on (node) group_left(instance) label_replace(node_uname_info, \"node\", \"$1\", \"nodename\", \"(.*)\")",
                              "instant": false,
                              "legendFormat": "{{ `{{` }}instance{{ `}}` }}",
                              "range": true,
                              "refId": "A"
                            }
                          ],
                          "title": "Worker Nodes",
                          "transformations": [],
                          "type": "piechart"
                        }
                      ],
                      "refresh": "30s",
                      "schemaVersion": 39,
                      "tags": [
                        "nativelink={{ .observed.composite.resource.spec.namespace.subdomain }}"
                      ],
                      "templating": {
                        "list": []
                      },
                      "time": {
                        "from": "now-15m",
                        "to": "now"
                      },
                      "timepicker": {},
                      "timezone": "utc",
                      "title": "Native Link ({{ .observed.composite.resource.spec.namespace.subdomain }})",
                      "weekStart": ""
                    }
                kind: ConfigMap
                metadata:
                  annotations:
                    "grafana_folder": "cloud-deployments"
                  labels:
                    grafana_dashboard: "1"
                    dashboard-provider: "sidecarProvider"
                  name: grafana-{{ .observed.composite.resource.spec.namespace.subdomain }}
                  namespace: nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}
          {{- end }}
  - step: render-worker-provisioner
    functionRef:
      name: crossplane-contrib-function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          {{- if gt .observed.composite.resource.spec.namespace.scheduler.replicas 0 }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: worker-provisioner-sa
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ServiceAccount
                metadata:
                  name: worker-provisioner
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: worker-provisioner-rolebinding
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: rbac.authorization.k8s.io/v1
                kind: RoleBinding
                metadata:
                  name: worker-provisioner-rolebinding
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                roleRef:
                  apiGroup: rbac.authorization.k8s.io
                  kind: ClusterRole
                  name: cluster-admin
                subjects:
                  - kind: ServiceAccount
                    name: worker-provisioner
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: worker-provisioner
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  labels:
                    nativelink: {{ .observed.composite.resource.spec.namespace.subdomain }}
                  name: worker-provisioner
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  progressDeadlineSeconds: 600
                  replicas: 1
                  revisionHistoryLimit: 10
                  selector:
                    matchLabels:
                      app: worker-provisioner
                  strategy:
                    rollingUpdate:
                      maxSurge: 25%
                      maxUnavailable: 25%
                    type: RollingUpdate
                  template:
                    metadata:
                      labels:
                        app: worker-provisioner
                        nativelink: {{ .observed.composite.resource.spec.namespace.subdomain }}
                    spec:
                      affinity:
                        {{- if .observed.composite.resource.spec.eks.awsAccountID }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: eks.amazonaws.com/capacityType
                                    operator: In
                                    values:
                                      - SPOT
                              weight: 100
                        {{- end }}
                        {{- if .observed.composite.resource.spec.gke.domain }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: cloud.google.com/gke-spot
                                    operator: In
                                    values:
                                      - "true"
                              weight: 100
                        {{- end }}
                        podAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - podAffinityTerm:
                                labelSelector:
                                  matchExpressions:
                                    - key: nativelink
                                      operator: In
                                      values:
                                        - "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                                topologyKey: topology.kubernetes.io/zone
                              weight: 100
                      containers:
                        - env:
                            - name: K8S_NAMESPACE
                              valueFrom:
                                fieldRef:
                                  apiVersion: v1
                                  fieldPath: metadata.namespace
                            - name: CAS_ENDPOINT
                              value: "cas"
                            {{- if .observed.composite.resource.spec.gke.domain }}
                            - name: CAS_GRPC_PORT
                              value: "50051"
                            - name: CLUSTER_TYPE
                              value: GKE
                            {{- end }}
                            - name: DEFAULT_WORKER_INIT_IMAGE
                              value: ghcr.io/tracemachina/nativelink-worker-init:{{ .observed.composite.resource.spec.namespace.scheduler.workerInitImageTag | default "p714jf1wnn7fhm7v011zykxcxn4zspkq" }}
                            - name: SCHEDULER_ENDPOINT
                              value: "scheduler"
                            - name: SCHEDULER_GRPC_PORT
                              value: "50061"
                            - name: NATIVELINK_APP
                              value: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                            - name: S3_STORE_SHARDS
                              value: "{{ .observed.composite.resource.spec.namespace.numShards }}"
                            {{- if .observed.composite.resource.spec.namespace.cas.acKeyPrefix }}
                            - name: AC_REDIS_STORE_KEY_PREFIX
                              value: "{{ .observed.composite.resource.spec.namespace.cas.acKeyPrefix }}"
                            {{- end }}
                            {{- if .observed.composite.resource.spec.namespace.cas.casKeyPrefix }}
                            - name: CAS_REDIS_STORE_KEY_PREFIX
                              value: "{{ .observed.composite.resource.spec.namespace.cas.casKeyPrefix }}"
                            {{- end}}
                            - name: CAS_FS_MAX_BYTES
                              value: "20G"
                            - name: METRICS_URL
                              value: http://mon-prometheus.monitoring.svc.cluster.local:9090
                            - name: AUTO_SCALING_CONFIG
                              value: config-maps/auto-scaling-config/auto-scaling-config.json
                            - name: WORKER_SPECS
                              value: config-maps/worker-specs/worker-specs.json
                            - name: METRICS_QUERIES_JSON
                              value: config-maps/metrics/metrics-queries.json
                            {{- if .observed.composite.resource.spec.eks.region }}
                            - name: NATIVE_LINK_AWS_REGION
                              value: "{{ .observed.composite.resource.spec.eks.region }}"
                            {{- if eq .observed.composite.resource.spec.namespace.deployType "shared" }}
                            - name: SHARED_CAS_BUCKET
                              value: "{{ .observed.composite.resource.spec.eks.sharedS3Bucket }}"
                            {{- else }}
                            - name: SHARED_CAS_BUCKET
                              value: "{{ .observed.composite.resource.status.bucketName }}"
                            - name: NATIVE_LINK_AWS_S3_CAS_BUCKET
                              value: "{{ .observed.composite.resource.status.bucketName }}"
                            {{- end }}
                            {{- end }}
                            {{- if .observed.composite.resource.spec.namespace.cas.browserEnabled }}
                            - name: CAS_BROWSER_ENDPOINT
                              {{- if .observed.composite.resource.spec.eks.domain }}
                              value: "browser-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.eks.domain }}"
                              {{- else }}
                              value: "browser-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.gke.domain }}"
                              {{- end }}
                            {{- end }}
                            - name: INDEX_PREFIX
                              value: aa__state_sort_key
                            - name: QUEUED_TASKS_QUERY
                              value: '@state:{ queued }'
                          envFrom:
                          - configMapRef:
                              name: redis-env
                              optional: false
                          image: public.ecr.aws/b1l4l6w7/nl-ext/worker-provisioner:multiarch
                          imagePullPolicy: Always
                          name: worker-provisioner
                          resources:
                            limits:
                              memory: 200Mi
                            requests:
                              memory: 100Mi
                          ports:
                          - containerPort: 8000
                            protocol: TCP
                            name: metrics
                          livenessProbe:
                            failureThreshold: 3
                            httpGet:
                              path: /live
                              port: 8000
                              scheme: HTTP
                            initialDelaySeconds: 2
                            periodSeconds: 10
                            successThreshold: 1
                            timeoutSeconds: 1
                          readinessProbe:
                            failureThreshold: 3
                            httpGet:
                              path: /ready
                              port: 8000
                              scheme: HTTP
                            initialDelaySeconds: 2
                            periodSeconds: 10
                            successThreshold: 1
                            timeoutSeconds: 1
                          volumeMounts:
                            - mountPath: /app/config-maps/metrics
                              name: metrics-queries
                            - mountPath: /app/config-maps/auto-scaling-config
                              name: auto-scaling-config
                      dnsPolicy: ClusterFirst
                      nodeSelector:
                        kubernetes.io/arch: arm64
                      restartPolicy: Always
                      securityContext: {}
                      serviceAccount: worker-provisioner
                      serviceAccountName: worker-provisioner
                      terminationGracePeriodSeconds: 30
                      tolerations:
                        - effect: NoSchedule
                          key: nativelink/tolerates-spot
                          operator: Exists
                        - key: cloud.google.com/gke-spot
                          operator: Exists
                          effect: NoSchedule
                      volumes:
                        - configMap:
                            defaultMode: 420
                            name: metrics-queries
                            optional: true
                          name: metrics-queries
                        - configMap:
                            defaultMode: 420
                            name: auto-scaling-config
                            optional: true
                          name: auto-scaling-config
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: wp-pod-monitor
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: monitoring.coreos.com/v1
                kind: PodMonitor
                metadata:
                  name: wp-podmonitor
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  namespaceSelector:
                    matchNames:
                      - "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  podMetricsEndpoints:
                    - path: /metrics
                      port: metrics
                  selector:
                    matchLabels:
                      app: worker-provisioner
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: worker-pod-monitor
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: monitoring.coreos.com/v1
                kind: PodMonitor
                metadata:
                  name: worker-podmonitor
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  namespaceSelector:
                    matchNames:
                      - "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  podMetricsEndpoints:
                    - path: /metrics
                      port: metrics
                  selector:
                    matchLabels:
                      app.kubernetes.io/component: worker
                      app.kubernetes.io/name: {{ .observed.composite.resource.spec.namespace.subdomain }}
          {{- end }}
  - step: render-bep-etl
    functionRef:
      name: crossplane-contrib-function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          {{- if .observed.composite.resource.spec.namespace.bep.enabled }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: bep-etl
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  labels:
                    nativelink: {{ .observed.composite.resource.spec.namespace.subdomain }}
                  name: bep-etl
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  progressDeadlineSeconds: 600
                  {{- if eq .observed.composite.resource.spec.namespace.deployState "deactivated" }}
                  replicas: 0
                  {{- else }}
                  replicas: 1
                  {{- end }}
                  revisionHistoryLimit: 10
                  selector:
                    matchLabels:
                      app: bep-etl
                  strategy:
                    rollingUpdate:
                      maxSurge: 25%
                      maxUnavailable: 25%
                    type: RollingUpdate
                  template:
                    metadata:
                      labels:
                        app: bep-etl
                        nativelink: {{ .observed.composite.resource.spec.namespace.subdomain }}
                    spec:
                      affinity:
                        {{- if .observed.composite.resource.spec.eks.awsAccountID }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: eks.amazonaws.com/capacityType
                                    operator: In
                                    values:
                                      - SPOT
                              weight: 100
                        {{- end }}
                        {{- if .observed.composite.resource.spec.gke.domain }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: cloud.google.com/gke-spot
                                    operator: In
                                    values:
                                      - "true"
                              weight: 100
                        {{- end }}
                        {{- if not .observed.composite.resource.spec.namespace.redis.disabled }}
                        podAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - podAffinityTerm:
                                labelSelector:
                                  matchExpressions:
                                    - key: nativelink
                                      operator: In
                                      values:
                                        - "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                                topologyKey: topology.kubernetes.io/zone
                              weight: 100
                        {{- end }}
                      containers:
                        - env:
                            - name: MONGODB_URI
                              value: "mongodb://mdb.mongodb.svc.cluster.local:27017"
                            - name: MONGODB_DATABASE
                              value: "bep"
                            - name: MONGODB_COLLECTION
                              value: "{{ or .observed.composite.resource.spec.namespace.bep.collection .observed.composite.resource.spec.namespace.subdomain }}"
                            - name: MONGODB_USER
                              value: "root"
                            - name: MONGODB_PASS
                              valueFrom:
                                secretKeyRef:
                                  key: mongodb-root-password
                                  name: mongodb-auth
                            - name: REDIS_PORT
                              value: "6379"
                           {{- if .observed.composite.resource.spec.namespace.bep.keyPrefix }}
                            - name: REDIS_KEY_PREFIX
                              value: "{{ .observed.composite.resource.spec.namespace.bep.keyPrefix }}"
                           {{- end }}
                          envFrom:
                          - configMapRef:
                              name: redis-env
                              optional: false
                          image: public.ecr.aws/b1l4l6w7/nl-ext/bep-etl:multiarch
                          imagePullPolicy: Always
                          name: bep-etl
                          resources:
                            requests:
                              memory: 64Mi
                      dnsPolicy: ClusterFirst
                      nodeSelector:
                        kubernetes.io/arch: arm64
                      restartPolicy: Always
                      securityContext: {}
                      terminationGracePeriodSeconds: 30
                      tolerations:
                        - effect: NoSchedule
                          key: nativelink/tolerates-spot
                          operator: Exists
                        - key: cloud.google.com/gke-spot
                          operator: Exists
                          effect: NoSchedule
          {{- end }}
  - step: render-bb-browser
    functionRef:
      name: crossplane-contrib-function-go-templating
    input:
      apiVersion: gotemplating.fn.crossplane.io/v1beta1
      kind: GoTemplate
      source: Inline
      inline:
        template: |
          {{- if .observed.composite.resource.spec.namespace.cas.browserEnabled }}
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: browser-config
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: ConfigMap
                metadata:
                  name: browser-config
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                data:
                  browser.json: |-
                    {
                        "blobstore": {
                            "actionCache": {
                              "grpc": {
                                "address": "cas.nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}.svc.cluster.local:50051"
                              }
                            },
                            "contentAddressableStorage": {
                              "grpc": {
                                "address": "cas.nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}.svc.cluster.local:50051"
                              }
                            }
                        },
                        "maximumMessageSizeBytes": 16777216,
                        "httpServers": [{
                            "listenAddresses": [":7984"],
                            "authenticationPolicy": { "allow": {} }
                        }],
                        "authorizer": {
                            "allow": {}
                        },
                        "requestMetadataLinksJmespathExpression" : "`{}`"
                    }
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: browser-deployment
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  labels:
                    nativelink: {{ .observed.composite.resource.spec.namespace.subdomain }}
                  name: bb-browser
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  progressDeadlineSeconds: 600
                  replicas: 1
                  revisionHistoryLimit: 10
                  selector:
                    matchLabels:
                      app: bb-browser
                  strategy:
                    rollingUpdate:
                      maxSurge: 25%
                      maxUnavailable: 25%
                    type: RollingUpdate
                  template:
                    metadata:
                      labels:
                        app: bb-browser
                    spec:
                      affinity:
                        {{- if .observed.composite.resource.spec.eks.awsAccountID }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: eks.amazonaws.com/capacityType
                                    operator: In
                                    values:
                                      - SPOT
                              weight: 100
                        {{- end }}
                        {{- if .observed.composite.resource.spec.gke.domain }}
                        nodeAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - preference:
                                matchExpressions:
                                  - key: cloud.google.com/gke-spot
                                    operator: In
                                    values:
                                      - "true"
                              weight: 100
                        {{- end }}
                        podAffinity:
                          preferredDuringSchedulingIgnoredDuringExecution:
                            - podAffinityTerm:
                                labelSelector:
                                  matchExpressions:
                                    - key: nativelink
                                      operator: In
                                      values:
                                        - "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                                topologyKey: topology.kubernetes.io/zone
                              weight: 100
                      containers:
                        - args:
                            - --whitelist-domain=.amazoncognito.com
                          envFrom:
                            - configMapRef:
                                name: oauth2-proxy-config-{{ .observed.composite.resource.spec.namespace.subdomain }}
                            - secretRef:
                                name: oauth2-proxy-client
                          image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
                          imagePullPolicy: IfNotPresent
                          livenessProbe:
                            failureThreshold: 3
                            httpGet:
                              path: /ping
                              port: 8888
                              scheme: HTTP
                            initialDelaySeconds: 5
                            periodSeconds: 5
                            successThreshold: 1
                            timeoutSeconds: 1
                          name: oauth2-proxy
                          ports:
                            - containerPort: 8888
                              name: proxy
                              protocol: TCP
                          readinessProbe:
                            failureThreshold: 3
                            httpGet:
                              path: /ping
                              port: 8888
                              scheme: HTTP
                            initialDelaySeconds: 5
                            periodSeconds: 5
                            successThreshold: 1
                            timeoutSeconds: 1
                          resources:
                            limits:
                              memory: 200Mi
                            requests:
                              memory: 100Mi
                        - image: ghcr.io/buildbarn/bb-browser:20240613t055327z-f0fbe96@sha256:1c4c1d994639e7ccc90b69b26fb8cc97a0b1dc9b4165ac74d30c92dc3704126e
                          imagePullPolicy: IfNotPresent
                          name: bb-browser
                          ports:
                            - containerPort: 7984
                              name: http
                              protocol: TCP
                          volumeMounts:
                            - mountPath: /config
                              name: browser-config
                          resources:
                            requests:
                              memory: 64Mi
                          args: ["config/browser.json"]
                      volumes:
                        - configMap:
                            defaultMode: 420
                            name: browser-config
                          name: browser-config
                      dnsPolicy: ClusterFirst
                      nodeSelector:
                        kubernetes.io/arch: arm64
                      restartPolicy: Always
                      securityContext: {}
                      terminationGracePeriodSeconds: 30
                      tolerations:
                        - effect: NoSchedule
                          key: nativelink/tolerates-spot
                          operator: Exists
                        - key: cloud.google.com/gke-spot
                          operator: Exists
                          effect: NoSchedule
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: browser-service
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: v1
                kind: Service
                metadata:
                  name: browser
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                  labels:
                    nativelink: "{{ .observed.composite.resource.spec.namespace.subdomain }}"
                    app.kubernetes.io/name: browser
                spec:
                  selector:
                    app: bb-browser
                  ports:
                    - name: browser
                      protocol: TCP
                      port: 7984
                      targetPort: 8888
          ---
          apiVersion: kubernetes.crossplane.io/v1alpha1
          kind: Object
          metadata:
            annotations:
              gotemplating.fn.crossplane.io/composition-resource-name: browser-ingress
          spec:
            providerConfigRef:
              name: provider-config-kubernetes
            forProvider:
              manifest:
                apiVersion: networking.k8s.io/v1
                kind: Ingress
                metadata:
                  annotations:
                    {{- if .observed.composite.resource.spec.eks.clusterIssuer }}
                    cert-manager.io/cluster-issuer: "{{ .observed.composite.resource.spec.eks.clusterIssuer }}"
                    {{- else }}
                    cert-manager.io/cluster-issuer: "{{ .observed.composite.resource.spec.gke.clusterIssuer }}"
                    {{- end }}
                  labels:
                    nativelink-account: {{ .observed.composite.resource.spec.namespace.accountId }}
                  name: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}-browser"
                  namespace: "nativelink-{{ .observed.composite.resource.spec.namespace.subdomain }}"
                spec:
                  ingressClassName: nginx
                  rules:
                    - {{- if .observed.composite.resource.spec.eks.domain }}
                      host: "browser-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.eks.domain }}"
                      {{- else }}
                      host: "browser-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.gke.domain }}"
                      {{- end }}
                      http:
                        paths:
                          - backend:
                              service:
                                name: browser
                                port:
                                  number: 7984
                            path: /
                            pathType: Prefix
                  tls:
                    - hosts:
                      - {{- if .observed.composite.resource.spec.eks.domain }}
                        "browser-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.eks.domain }}"
                        {{- else }}
                        "browser-{{ .observed.composite.resource.spec.namespace.subdomain }}.{{ .observed.composite.resource.spec.gke.domain }}"
                        {{- end }}
                      {{- if eq .observed.composite.resource.spec.namespace.deployType "shared" }}
                      secretName: nativelink-tls
                      {{- else }}
                      secretName: nativelink-tls-browser
                      {{- end }}
          {{- end }}
  - step: ready
    functionRef:
      name: crossplane-contrib-function-auto-ready
  compositeTypeRef:
    apiVersion: tracemachina.com/v1alpha1
    kind: NativeLink
